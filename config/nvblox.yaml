# =============================================================================
# nvblox Configuration — Greenhouse AGV TSDF Coverage Mapping
# =============================================================================
# Replaces RTAB-Map for real-time 3D mesh/TSDF reconstruction.
# Used with cuVSLAM providing TF odometry (odom -> base_link).
# ZED 2i provides depth + color at 30Hz.
#
# Key tuning for greenhouse:
#   - 5cm voxels (matches previous RTAB-Map node spacing)
#   - Static TSDF mode (no dynamic people tracking needed)
#   - 5m max integration distance (greenhouse aisle width ~3-4m)
#   - TF-based pose (from cuVSLAM, not ZED pose)
#   - 2D ESDF for coverage visualization
# =============================================================================
/**:
  ros__parameters:
    # -- Stream settings --
    cuda_stream_type: 1  # blocking async

    # -- Map resolution --
    voxel_size: 0.05  # 5cm voxels — matches RTAB-Map node spacing
    num_cameras: 1
    mapping_type: "static_tsdf"

    # -- Pose source --
    # Use TF lookups (cuVSLAM publishes odom -> base_link)
    use_tf_transforms: true
    # Global frame = odom (cuVSLAM provides this)
    global_frame: "odom"

    # -- Processing rates --
    tick_period_ms: 10
    integrate_depth_rate_hz: 30.0   # Match ZED framerate
    integrate_color_rate_hz: 5.0    # Color less critical
    integrate_lidar_rate_hz: 0.0    # No lidar
    update_mesh_rate_hz: 5.0        # Mesh for Foxglove viz
    update_esdf_rate_hz: 2.0        # ESDF for coverage
    publish_layer_rate_hz: 2.0      # Publish mesh/map layers
    publish_debug_vis_rate_hz: 1.0
    decay_tsdf_rate_hz: 0.0         # No decay — we want persistent map
    decay_dynamic_occupancy_rate_hz: 0.0
    clear_map_outside_radius_rate_hz: 0.0  # No clearing — build full map

    # -- Console output --
    print_rates_to_console: false
    print_timings_to_console: false
    print_delays_to_console: false
    print_queue_drops_to_console: false
    print_statistics_on_console_period_ms: 30000

    # -- ESDF settings --
    esdf_mode: "2d"
    publish_esdf_distance_slice: true

    # -- Sensor settings --
    use_color: true
    use_depth: true
    use_lidar: false

    # -- Input queue --
    maximum_input_queue_length: 10

    # -- Map clearing --
    # Disable clearing — we want to build a complete greenhouse map
    map_clearing_radius_m: -1.0  # negative = disabled
    map_clearing_frame_id: "base_link"

    # -- QoS --
    input_qos: "SENSOR_DATA"  # Best effort for ZED sensor data

    # -- Visualization --
    esdf_slice_bounds_visualization_attachment_frame_id: "base_link"
    esdf_slice_bounds_visualization_side_length: 15.0
    workspace_height_bounds_visualization_attachment_frame_id: "base_link"
    workspace_height_bounds_visualization_side_length: 15.0
    layer_visualization_min_tsdf_weight: 0.1
    layer_visualization_exclusion_height_m: 3.0
    layer_visualization_exclusion_radius_m: -1.0  # No exclusion
    layer_visualization_undo_gamma_correction: false
    max_back_projection_distance: 5.0
    back_projection_subsampling: 1
    layer_streamer_bandwidth_limit_mbps: -1.0  # Unlimited

    multi_mapper:
      connected_mask_component_size_threshold: 2000
      remove_small_connected_components: true

    static_mapper:
      # -- Depth preprocessing (nvblox internal) --
      do_depth_preprocessing: false  # ZED NEURAL depth already good

      # -- Projective integrator --
      projective_integrator_max_integration_distance_m: 5.0  # Greenhouse aisles ~3-4m
      projective_integrator_truncation_distance_vox: 4.0
      projective_integrator_weighting_mode: "inverse_square_tsdf_distance_penalty"
      projective_integrator_max_weight: 10.0  # Higher for stable reconstruction
      projective_tsdf_integrator_invalid_depth_decay_factor: -1.0

      # -- View calculator --
      raycast_subsampling_factor: 4
      workspace_bounds_type: "height_bounds"  # Constrain to greenhouse height
      workspace_bounds_min_height_m: -0.2     # Below ground slightly
      workspace_bounds_max_height_m: 3.0      # Greenhouse ceiling ~2.5-3m

      # -- ESDF integrator --
      esdf_integrator_min_weight: 0.1
      esdf_integrator_max_site_distance_vox: 2.0
      esdf_integrator_max_distance_m: 2.0
      esdf_slice_height: 0.5   # Slice at 50cm (below camera, above ground)
      esdf_slice_min_height: 0.0
      esdf_slice_max_height: 1.0

      # -- Mesh integrator --
      mesh_integrator_min_weight: 0.1
      mesh_integrator_weld_vertices: true

      # -- TSDF decay --
      # Decay rate set to near-zero effect; decay_tsdf_rate_hz: 0.0 above
      # prevents the integrator from running, but the value must be < 1.0
      tsdf_decay_factor: 0.95
      tsdf_decayed_weight_threshold: 0.001
      exclude_last_view_from_decay: true
      tsdf_set_free_distance_on_decayed: false
      decay_integrator_deallocate_decayed_blocks: false

      # -- Mesh streamer --
      layer_streamer_exclusion_height_m: 3.0
      layer_streamer_exclusion_radius_m: -1.0  # No exclusion
